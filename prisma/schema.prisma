generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum UserRole {
  LANDLORD
  TENANT
}

enum PlanType {
  SINGLE_HOUSEHOLD
  MULTI_TENANT
}

enum HouseholdRole {
  OWNER
  TENANT
}

model User {
  id    Int      @id @default(autoincrement())
  email String   @unique
  name  String?
  role  UserRole @default(LANDLORD)

  households            Household[]       @relation("UserHouseholds")
  householdMemberships  HouseholdMember[]
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
}

model Household {
  id   Int      @id @default(autoincrement())
  name String
  plan PlanType @default(SINGLE_HOUSEHOLD)

  ownerId Int
  owner   User @relation("UserHouseholds", fields: [ownerId], references: [id])

  homeAssistant HomeAssistantInstance?
  spotifyToken  SpotifyToken?
  members       HouseholdMember[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model HouseholdMember {
  id          Int           @id @default(autoincrement())
  userId      Int
  householdId Int
  role        HouseholdRole

  /// Optional Home Assistant Area filter (e.g. "Room 1", "Bedroom 2").
  /// TENANTs will only see entities whose areaName matches this.
  areaFilter  String?

  /// Optional label filter â€“ comma-separated list of HA label names.
  /// If set, tenant will only see devices whose labels intersect this list.
  labelFilterCsv String?

  user      User      @relation(fields: [userId], references: [id])
  household Household @relation(fields: [householdId], references: [id])

  @@unique([userId, householdId])
}

model HomeAssistantInstance {
  id          Int       @id @default(autoincrement())
  householdId Int       @unique
  household   Household @relation(fields: [householdId], references: [id])

  baseUrl     String // e.g. http://homeassistant.local:8123
  accessToken String // long-lived HA token (later: per-user tokens / service account)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SpotifyToken {
  id          Int       @id @default(autoincrement())
  householdId Int       @unique
  household   Household @relation(fields: [householdId], references: [id])

  accessToken  String
  refreshToken String
  scope        String
  tokenType    String
  expiresAt    DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
